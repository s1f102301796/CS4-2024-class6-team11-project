<!DOCTYPE html>
<html>
<head>
    <title>Chess Game</title>

    <!-- 必要なCSSとJSを読み込み -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <style>
        #board {
            width: 400px;
            margin: 20px auto;
        }
    </style>
</head>
<body>
    <h1>Chess Game</h1>
    <div id="board"></div>
    <div id="status"></div>

    <script>
        // Chess.js のインスタンスを作成
        const game = new Chess();

        // Chessboard.js の初期化
        const board = Chessboard('board', {
            draggable: true,
            dropOffBoard: 'snapback',
            position: 'start',
            pieceTheme: '/static/img/chesspieces/wikipedia/{piece}.png', // 駒画像のパス
            onDrop: onDrop, // 駒を移動したときの処理
        });

        // 駒を移動した際の処理
        function onDrop(source, target) {
            // 移動を chess.js に適用
            const move = game.move({
                from: source,
                to: target,
                promotion: 'q' // ポーンが最終列に到達した場合の昇格（デフォルトでクイーン）
            });

            // 非合法な手の場合はスナップバック
            if (move === null) return 'snapback';

            // 移動を反映したら、更新されたゲームの状態を表示
            updateStatus();
        }

        // 状態を更新する関数
        function updateStatus() {
            let status = '';

            if (game.in_checkmate()) {
                // チェックメイトの判定
                status = 'Checkmate!';
            } else if (game.in_draw()) {
                // 引き分けの判定
                status = 'Draw!';
            } else {
                const moveColor = game.turn() === 'w' ? 'White' : 'Black';
                status = moveColor + "'s turn";

                if (game.in_check()) {
                    // チェック状態の判定
                    status += ', in check';
                }
            }

            document.getElementById('status').innerText = status;
        }

        // 初期状態の更新
        updateStatus();
    </script>
</body>
</html>
